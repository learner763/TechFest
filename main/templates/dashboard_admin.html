<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    body{
        margin: 0;
        font-family: sans-serif;
        padding: 20px;
        background-color: darkgreen;
    }
    a{
        color: white;
        font-size: 20px;
    }
    .personal_details {
        display: flex;
        justify-self: center;
        flex-direction: column;
        font-size: 20px;
        color: white;
        align-items: center;
        gap: 10px;
        background-color: white;
        padding: 20px;
        margin: 0px 100px 0px 100px;
        scrollbar-width: none;
        overflow: scroll;
        height: 100px;
        width: 100%;
    }
    .personal_details div{
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        width: 100%;
        gap: 10px;
    }
    .personal_details label{
        min-width: 150px;
        max-width: 150px;
        color: darkgreen;
        overflow-wrap: break-word;
    }
    h1,h2{
        color: white;
        align-self: center;
    }
    button,select{
        padding: 5px;
        color: darkgreen;
        background-color: white;
        font-size: 20px;
        border-radius: 10px;
        cursor: pointer;
        width: 200px;
    }
    .update_subuser label,.delete_subuser label{
        color: darkgreen;
        font-weight: bold;
        font-size: 20px;
    }
    .update_subuser,.delete_subuser{
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        flex-direction: column;        
    }
    input{
        padding: 5px;
        font-size: 20px;
        border: none;
        border-radius: 10px;
    }
    dialog{
        font-size: 20px;
        color: white;
        background-color: black;
        border-radius: 20px;
        
    }
    dialog button{
        border: none;
        width: auto;
    }
    .adding_data{
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        color: darkgreen;
    }
    .adding_data label{
        font-weight: bold;
    }
    .adding_data input,.adding_data select{
        margin-bottom: 10px;
    }
    .delete_subuser,.update_subuser,.adding_data{
        background-color: white;
        border-radius: 20px;
        padding: 10px;
        width: 300px;
    }
    .delete_subuser h2,.update_subuser h2,.adding_data h2{
        color: darkgreen;
    }
    .user_record{
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 200px;
        overflow: scroll;
        padding: 20px;
        scrollbar-width: none;
        margin: 0px 100px 0px 100px;
        background-color: white;
        color: darkgreen;
        font-size: 20px;
        gap: 10px;
        justify-self: center;
        width: 100%;
    }
    .user_record div{
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        gap: 10px;
        width: 100%;
        margin-bottom: 10px;
    }
    .user_record label{
        min-width: 150px;
        max-width: 150px;
        overflow-wrap: break-word;
    }
    #user{
        font-weight: bold;
        font-size: 30px;
        align-self: center;
        color: white;
        margin-top: 25px;
    }
    .container{
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: space-around;
        margin: 30px 0px 10px 0px;
    }
    .container input,.container select,.container button{
        border: 1px black solid;
    }
    @media(max-width:500px)
    {
        .container input{
            width: 187px;
        }
        #AdminDashboard{
            font-size: 25px;
        }
        a{
            font-size: 15px;
        }
    }
</style>
<body>
    <div style="display: flex;flex-direction: column;">
        <a href="/login_admin" style="align-self: flex-end;">Back to Login</a>
        <label id="user"></label>
        <h1 id="AdminDashboard">Admin Dashboard</h1>
        <h2>Admin Data</h1>
    </div>
    <div class="personal_details">
        <div style="font-weight: bold;color: darkgreen;">
            <label>ID</label>
            <label>First Name</label>
            <label>Last Name</label>
            <label>Email</label>
            <label>Password</label>
            <label>Phone</label>
            <label>Mode</label>
        </div>
    </div>
    <div style="display: flex;justify-content: center;align-items: center;width: 100%;"><h2>SubUsers Record</h2></div>
    <div class="user_record">
        <div style="font-weight: bold;">
            <label>ID</label>
            <label>First Name</label>
            <label>Last Name</label>
            <label>Email</label>
            <label>Password</label>
            <label>Phone</label>
            <label>Mode</label>
        </div>
    </div>
    <div class="container">
        <div class="adding_data">
            <h2 style="font-size: x-large;">Add SubUsers</h2>
            <label >First Name:</label>
            <input type="text" placeholder="First Name" id="sub_first_name">
            <label >Last Name:</label>
            <input type="text" placeholder="Last Name" id="sub_last_name">
            <label >Email:</label>
            <input type="email" placeholder="Email" id="sub_email">
            <label >Password:</label>
            <input type="password" placeholder="Password" id="sub_password">
            <label >Phone:</label>
            <input type="number" placeholder="Phone" id="sub_phone">
            <label>Select Mode</label>
            <select  id="Select Mode">
                <option value="Employee">Employee</option>
                <option value="Admin">Admin</option>
            </select>
            <button id="add_subuser">Add SubUser</button>
        </div>
        <div class="update_subuser">
            <h2 style="align-self: center;">Update Subuser/Your Data</h2>
            <label>Enter Id:</label>
            <input type="number" id="update_subuser_id" placeholder="Type Id...">
            <select id="update_subuser_dropdown">
                <option value="Select Field">Select Field</option>
                <option value="first_name">First_name</option>
                <option value="last_name">Last_name</option>
                <option value="email">Email</option>
                <option value="password">Password</option>
                <option value="phone">Phone</option>
                <option value="mode">Mode(Enter Admin or Employee)</option>
            </select>
            <input type="text" id="update_subuser_value" placeholder="Type New Value...">
            <button id="update_subuser">Update Data</button>
        </div>
        <div class="delete_subuser">
            <h2>Delete SubUser</h2>
            <label>Enter Id:</label>
            <input type="number" id="delete_subuser_id" placeholder="Type Id...">
            <button id="delete_subuser">Delete SubUser</button>
        </div>
    </div>
    <dialog id="dialog"></dialog>
    <script>
        if(localStorage.getItem('email')===null){
            alert(`Please Login/Register First`)
            window.location.href='/login_admin';
        }
        document.getElementById('user').innerHTML=localStorage.getItem('email')
        document.body.style.display='none'     
        let subuser=document.getElementById('add_subuser'); 
        let sub_first_name=document.getElementById('sub_first_name');
        let sub_last_name=document.getElementById('sub_last_name');
        let sub_phone=document.getElementById('sub_phone');
        let sub_email=document.getElementById('sub_email');
        let sub_password=document.getElementById('sub_password');     
        let update_subuser=document.getElementById('update_subuser');

        update_subuser.addEventListener('click',()=>
        {
            if(document.getElementById('update_subuser_id').value==='' || document.getElementById('update_subuser_dropdown').value==='Select Field' || document.getElementById('update_subuser_value').value===''){
                dialog.showModal();
                dialog.innerHTML=`Please fill up the required fields <p></p><button style="cursor: pointer;" onclick="dialog.close()">OK</button>`;
            }
            else{
                fetch('/dashboard_admin/update_subuser',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        email:localStorage.getItem('email'),
                        id:document.getElementById('update_subuser_id').value,
                        field:document.getElementById('update_subuser_dropdown').value,
                        value:document.getElementById('update_subuser_value').value
                    })
                })
                .then(responce=>responce.json())
                .then(data=>
                {
                    if(data.success)
                    {
                        dialog.showModal();
                        dialog.innerHTML=`Record Updated Successfully! <p></p><button style="cursor: pointer;" onclick="dialog.close()">OK</button>`;
                        let index=0
                        let stop=false
                        index=data.field==='first_name'?1:data.field==='last_name'?2:data.field==='email'?3:data.field==='password'?4:data.field==='phone'?5:6;    
                        for(let i=1;i<document.getElementsByClassName('user_record')[0].children.length;i++)
                        {
                            if(document.getElementsByClassName('user_record')[0].children[i].children[0].innerHTML===data.id)
                            {
                                let new_val=''
                                let old_val=''
                                if(data.field==='mode')
                                {
                                    new_val=document.getElementsByClassName('user_record')[0].children[i].children[index].innerHTML
                                    old_val= data.value
                                }
                                document.getElementsByClassName('user_record')[0].children[i].children[index].innerHTML=data.value
                                stop=true
                                if(new_val!==old_val)
                                {
                                    let element=document.getElementsByClassName('user_record')[0].children[i]
                                    document.getElementsByClassName('user_record')[0].removeChild(element)
                                    document.getElementsByClassName('personal_details')[0].appendChild(element)
                                }
                                break
                            }
                        }
                        if(!stop)
                        {
                            for(let i=1;i<document.getElementsByClassName('personal_details')[0].children.length;i++)
                            {
                                if(document.getElementsByClassName('personal_details')[0].children[i].children[0].innerHTML===data.id)
                                {
                                    let new_val=''
                                    let old_val=''
                                    if(data.field==='mode')
                                    {
                                        new_val=document.getElementsByClassName('personal_details')[0].children[i].children[index].innerHTML
                                        old_val= data.value
                                    }
                                    document.getElementsByClassName('personal_details')[0].children[i].children[index].innerHTML=data.value
                                    stop=true
                                    if(new_val!==old_val)
                                    {
                                        let element=document.getElementsByClassName('personal_details')[0].children[i]
                                        document.getElementsByClassName('personal_details')[0].removeChild(element)
                                        document.getElementsByClassName('user_record')[0].appendChild(element)
                                    }
                                    break
                                }
                            }
                        }

                        document.getElementById('update_subuser_id').value=''
                        document.getElementById('update_subuser_dropdown').value='Select Field'
                        document.getElementById('update_subuser_value').value=''
                    }
                    else if(data.message)
                    {
                        dialog.showModal();
                        dialog.innerHTML=`${data.message} <p></p><button style="cursor: pointer;" onclick="dialog.close()">OK</button>`;
                    }
                })
            }
        })
        subuser.addEventListener('click',()=>
        {
            if(sub_first_name.value==='' || sub_last_name.value==='' || sub_email.value==='' || sub_password.value==='' || sub_phone.value==='')
            {
                dialog.showModal();
                dialog.innerHTML=`Please fill up the required fields <p></p><button style="cursor: pointer;" onclick="dialog.close()">OK</button>`;
            }
            else{
                fetch('/dashboard_admin/add_subuser',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        first_name:document.getElementById('sub_first_name').value,
                        last_name:document.getElementById('sub_last_name').value,
                        email:document.getElementById('sub_email').value,
                        password:document.getElementById('sub_password').value,
                        phone:document.getElementById('sub_phone').value,
                        mode:document.getElementById('Select Mode').value,
                        group:localStorage.getItem('group')
                    })
                })
                .then(responce=>responce.json())
                .then(data=>
                {
                    if(data.success)
                    {
                        dialog.showModal();
                        dialog.innerHTML=`SubUser added successfully <p></p><button style="cursor: pointer;" onclick="dialog.close()">OK</button>`;
                        document.getElementById('sub_first_name').value=''
                        document.getElementById('sub_last_name').value=''
                        document.getElementById('sub_email').value=''
                        document.getElementById('sub_password').value=''
                        document.getElementById('sub_phone').value=''
                        document.getElementById('Select Mode').value='Employee'
                        console.log(data);
                        let div=document.createElement('div');
                        let id=document.createElement('label');
                        id.innerText=data.id;
                        let first_name=document.createElement('label');
                        first_name.innerText=data.first_name;
                        let last_name=document.createElement('label');
                        last_name.innerText=data.last_name;
                        let email=document.createElement('label');
                        email.innerText=data.email;
                        let password=document.createElement('label');
                        password.innerText=data.password;
                        let phone=document.createElement('label');
                        phone.innerText=Number(data.phone);
                        let mode=document.createElement('label');
                        mode.innerText=data.mode;
                        div.appendChild(id);
                        div.appendChild(first_name);
                        div.appendChild(last_name);
                        div.appendChild(email);
                        div.appendChild(password);
                        div.appendChild(phone);
                        div.appendChild(mode);
                        if(data.mode==='Employee'){document.getElementsByClassName('user_record')[0].appendChild(div)}
                        else {document.getElementsByClassName('personal_details')[0].appendChild(div)}
                    }
                    else if(data.message)
                    {
                        dialog.showModal();
                        dialog.innerHTML=`${data.message} <p></p><button style="cursor: pointer;" onclick="dialog.close()">OK</button>`;
                    }
                }
                )
            }
        })     
        fetch('/dashboard_admin/personal_data',
        {
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify({
                group:localStorage.getItem('group')
            })
        }
        )
        .then(responce=>responce.json())
        .then(data=>
            {
                for(let i=0;i<data.data.length;i++)
                {
                    let div=document.createElement('div');
                    let id=document.createElement('label');
                    id.innerText=data.data[i].id;
                    let first_name=document.createElement('label');
                    first_name.innerText=data.data[i].first_name;
                    let last_name=document.createElement('label');
                    last_name.innerText=data.data[i].last_name;
                    let email=document.createElement('label');
                    email.innerText=data.data[i].email;
                    let password=document.createElement('label');
                    password.innerText=data.data[i].password;
                    let phone=document.createElement('label');
                    phone.innerText=Number(data.data[i].phone);
                    let mode=document.createElement('label');
                    mode.innerText=data.data[i].mode;
                    div.appendChild(id);
                    div.appendChild(first_name);
                    div.appendChild(last_name);
                    div.appendChild(email);
                    div.appendChild(password);
                    div.appendChild(phone);
                    div.appendChild(mode);
                    document.getElementsByClassName('personal_details')[0].appendChild(div);
                }
            }
            
        )
        fetch('/dashboard_admin/subusers_data',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify({
                group:localStorage.getItem('group')
            })
        })
        .then(responce=>responce.json())
        .then(data=>
        {
            for(let i=0;i<data.data.length;i++)
            {
                let div=document.createElement('div');
                let id=document.createElement('label');
                id.innerText=data.data[i].id;
                let first_name=document.createElement('label');
                first_name.innerText=data.data[i].first_name;
                let last_name=document.createElement('label');
                last_name.innerText=data.data[i].last_name;
                let email=document.createElement('label');
                email.innerText=data.data[i].email;
                let password=document.createElement('label');
                password.innerText=data.data[i].password;
                let phone=document.createElement('label');
                phone.innerText=Number(data.data[i].phone);
                let mode=document.createElement('label');
                mode.innerText=data.data[i].mode;
                div.appendChild(id);
                div.appendChild(first_name);
                div.appendChild(last_name);
                div.appendChild(email);
                div.appendChild(password);
                div.appendChild(phone);
                div.appendChild(mode);
                document.getElementsByClassName('user_record')[0].appendChild(div);
            }
            document.body.style.display='block'

        }
        )
        
        document.getElementById('delete_subuser').addEventListener('click',()=>
        {
            if(document.getElementById('delete_subuser_id').value==='')
            {
                dialog.showModal()
                dialog.innerHTML=`Please enter an ID to delete a user <p></p> <button onclick="dialog.close()">Close</button>`
            }
            else{
                fetch('/dashboard_admin/delete_subuser',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        id:document.getElementById('delete_subuser_id').value
                    })
                })
                .then(responce=>responce.json())
                .then(data=>
                {
                    if(data.success)
                    {
                        dialog.showModal()
                        dialog.innerHTML=`User deleted successfully <p></p> <button onclick="dialog.close()">Close</button>`
                        document.getElementById('delete_subuser_id').value=''
                        for(let i=1;i<document.getElementsByClassName('user_record')[0].children.length;i++)
                        {
                            if(document.getElementsByClassName('user_record')[0].children[i].children[0].innerHTML===data.id)
                            {
                                document.getElementsByClassName('user_record')[0].removeChild(document.getElementsByClassName('user_record')[0].children[i])
                                break
                            }
                        }
                    }
                    else if(data.message)
                    {
                        dialog.showModal()
                        dialog.innerHTML=`${data.message} <p></p> <button onclick="dialog.close()">Close</button>`
                    }
                }
                )
            }
        })
    </script>
</body>
</html>